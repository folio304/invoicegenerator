<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vaada and Associates — Invoice</title>
<style>
  :root{--paper:#fff;--border:#000;--muted:#444;--maxw:900px}
  body{background:#f6f6f6;font-family:"Times New Roman",serif;padding:18px;color:#111}
  .wrap{max-width:var(--maxw);margin:0 auto;background:var(--paper);border:2px solid var(--border);padding:10px 14px}
  .header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid var(--border);padding-bottom:6px;margin-bottom:8px}
  .firm h2{margin:0;font-size:22px}
  .firm .sub{font-size:13px;margin-top:4px}
  .meta{text-align:right}
  .meta .label{font-size:12px;color:var(--muted)}
  .meta .val{font-weight:700}
  .customer-line{border:1px solid var(--border);padding:8px;margin-top:10px;text-transform:uppercase;font-weight:700;letter-spacing:.6px;display:flex;align-items:center;gap:10px}
  .customer-line input{border:0;border-bottom:1px dashed #000;background:transparent;font-weight:700;padding:4px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid var(--border);padding:6px}
  th{text-align:left}
  .tcenter{text-align:center}
  .tright{text-align:right}
  .muted{color:var(--muted);font-size:13px}
  input[type="text"],input[type="number"],select{font-family:inherit;padding:6px;border:1px solid #222;background:transparent}
  input[type="number"]{text-align:right}
  .totals{margin-top:8px;display:flex;justify-content:flex-end}
  .totals .box{width:320px;border-top:1px solid var(--border);padding-top:8px}
  .totals .line{display:flex;justify-content:space-between;padding:6px 2px;border-bottom:1px dotted #999}
  .bold{font-weight:700}
  .footer{margin-top:16px;border-top:2px solid var(--border);padding-top:8px;display:flex;justify-content:space-between;align-items:center}
  .signature{width:240px;text-align:center;border-top:1px solid #111;padding-top:6px;font-size:14px}
  .thank{font-size:15px;font-weight:700}
  .bottom-controls{max-width:var(--maxw);margin:18px auto 0;display:flex;flex-wrap:wrap;justify-content:center;gap:10px}
  .btn{padding:8px 12px;border-radius:4px;border:1px solid #222;background:#fff;cursor:pointer;font-family:inherit}
  .btn.primary{background:#111;color:#fff}
  .small{font-size:13px;padding:6px 10px}
  .col-small{width:80px}
  @media print{
    body{background:white}
    .bottom-controls{display:none}
    .wrap{border:0;padding:0;max-width:100%}
  }
  /* small nicety to make editable cells look like fields */
  td.editable{background:transparent}
  td.editable:focus{outline:2px dashed #ddd}
</style>
</head>
<body>
<div class="wrap" id="invoiceWrap">
  <div class="header">
    <div class="firm">
      <h2>VAADA AND ASSOCIATES</h2>
      <div class="sub">GSTIN: AFBOA2040N1Z3</div>
      <div class="sub">Raipur, C.G.</div>
      <div class="sub">Contact: 7828780780</div>
    </div>
    <div class="meta">
      <div class="label">Invoice No.</div>
      <div class="val" id="invoiceNoPreview">INV-1</div>
      <div style="height:10px"></div>
      <div class="label">Date</div>
      <div><input id="invoiceDate" type="date"></div>
    </div>
  </div>

  <!-- Customer name input (optional) -->
  <div class="customer-line">
    <div style="font-weight:700">CUSTOMER NAME:</div>
    <input id="customerName" type="text" placeholder="(leave blank if you will write by hand)" />
  </div>

  <table aria-label="items">
    <thead>
      <tr>
        <th style="width:6%">S. NO.</th>
        <th style="width:54%">Item / Remark</th>
        <th style="width:12%" class="tcenter">QTY</th>
        <th style="width:14%" class="tright">RATE</th>
        <th style="width:14%" class="tright">AMOUNT</th>
      </tr>
    </thead>
    <tbody id="itemsBody">
      <!-- rows inserted dynamically -->
    </tbody>
  </table>

  <div class="totals">
    <div class="box">
      <div class="line"><div class="muted">Taxable Value</div><div id="taxableText" class="tright">₹0.00</div></div>
      <div class="line"><div class="muted">CGST @ <span id="cgstRate">0</span>%</div><div id="cgstText" class="tright">₹0.00</div></div>
      <div class="line"><div class="muted">SGST @ <span id="sgstRate">0</span>%</div><div id="sgstText" class="tright">₹0.00</div></div>
      <div class="line bold" style="border-top:2px solid #000"><div>Total</div><div id="totalText" class="tright">₹0.00</div></div>
    </div>
  </div>

  <div class="footer">
    <div class="muted">पुनः पधारें धन्यवाद !</div>
    <div class="signature">Authorised Signatory</div>
  </div>
</div>

<!-- BOTTOM TOOLBAR -->
<div class="bottom-controls">
  <button id="addRow" class="btn small">+ Add Row</button>
  <button id="clearRows" class="btn small">Clear Items</button>
  <label class="muted" style="align-self:center">GST:</label>
  <select id="gstRate" class="small">
    <option value="0">No GST</option>
    <option value="5">5%</option>
    <option value="18" selected>18%</option>
  </select>
  <button id="savePrint" class="btn primary">Save &amp; Print</button>
  <button id="reset" class="btn">Reset</button>
</div>

<script>
  // Storage keys
  const KEY_NEXT = 'vaada_next_invoice';
  const KEY_SAVED = 'vaada_saved_invoices';

  // Elements
  const invoiceNoPreview = document.getElementById('invoiceNoPreview');
  const invoiceDate = document.getElementById('invoiceDate');
  const customerNameEl = document.getElementById('customerName');
  const gstRateEl = document.getElementById('gstRate');
  const addRowBtn = document.getElementById('addRow');
  const clearRowsBtn = document.getElementById('clearRows');
  const savePrintBtn = document.getElementById('savePrint');
  const resetBtn = document.getElementById('reset');
  const itemsBody = document.getElementById('itemsBody');
  const taxableText = document.getElementById('taxableText');
  const cgstText = document.getElementById('cgstText');
  const sgstText = document.getElementById('sgstText');
  const totalText = document.getElementById('totalText');
  const cgstRateSpan = document.getElementById('cgstRate');
  const sgstRateSpan = document.getElementById('sgstRate');

  // Utilities
  function getNext(){ const raw = localStorage.getItem(KEY_NEXT); let n = raw ? parseInt(raw,10) : 1; if(!Number.isFinite(n) || n<1) n=1; return n; }
  function setNext(n){ localStorage.setItem(KEY_NEXT, String(n)); }
  function bumpNext(){ setNext(getNext() + 1); }
  function getSaved(){ try{ return JSON.parse(localStorage.getItem(KEY_SAVED) || '[]'); }catch(e){ return []; } }
  function setSaved(list){ localStorage.setItem(KEY_SAVED, JSON.stringify(list)); }
  function formatINR(v){ return '₹' + (Number(v) || 0).toFixed(2); }

  // Init
  function init(){
    invoiceNoPreview.textContent = 'INV-' + getNext();
    invoiceDate.value = new Date().toISOString().slice(0,10);
    addItemRow(); // start with one
    updateTotals();
  }
  init();

  // Add item row (uses inputs for robustness)
  function addItemRow(data = {}) {
    const tr = document.createElement('tr');

    const tdSn = document.createElement('td');
    tdSn.className = 'tcenter';
    tdSn.textContent = itemsBody.children.length + 1;

    const tdDesc = document.createElement('td');
    const descInput = document.createElement('input');
    descInput.type = 'text'; descInput.style.width = '100%';
    descInput.value = data.desc || '';
    tdDesc.appendChild(descInput);

    const tdQty = document.createElement('td');
    tdQty.className = 'tcenter';
    const qtyInput = document.createElement('input');
    qtyInput.type = 'number'; qtyInput.min = '0'; qtyInput.step = '1'; qtyInput.value = data.qty || 1; qtyInput.className='col-small';
    tdQty.appendChild(qtyInput);

    const tdRate = document.createElement('td');
    tdRate.className = 'tright';
    const rateInput = document.createElement('input');
    rateInput.type = 'number'; rateInput.min = '0'; rateInput.step = '0.01'; rateInput.value = data.rate || 0; rateInput.className='col-small';
    tdRate.appendChild(rateInput);

    const tdAmount = document.createElement('td');
    tdAmount.className = 'tright';
    tdAmount.textContent = formatINR(0);

    // events
    [descInput, qtyInput, rateInput].forEach(el => el.addEventListener('input', updateTotals));

    tr.appendChild(tdSn);
    tr.appendChild(tdDesc);
    tr.appendChild(tdQty);
    tr.appendChild(tdRate);
    tr.appendChild(tdAmount);

    itemsBody.appendChild(tr);
    updateRowNumbers();
    updateTotals();
  }

  function updateRowNumbers(){
    Array.from(itemsBody.children).forEach((tr, i) => tr.children[0].textContent = i+1);
  }

  addRowBtn.addEventListener('click', ()=> addItemRow());
  clearRowsBtn.addEventListener('click', ()=>{
    if(confirm('Clear all items?')) {
      itemsBody.innerHTML = '';
      addItemRow();
      updateTotals();
    }
  });

  // Totals calculation
  function updateTotals(){
    const rows = Array.from(itemsBody.children);
    let taxable = 0;
    rows.forEach(tr=>{
      const qty = Number(tr.querySelector('input[type="number"]').value) || 0;
      const rate = Number(tr.querySelectorAll('input[type="number"]')[1].value) || 0;
      const amt = +(qty * rate);
      tr.children[4].textContent = formatINR(amt);
      taxable += amt;
    });

    const gst = Number(gstRateEl.value) || 0;
    const totalTax = +(taxable * gst / 100);
    const cgst = +(totalTax/2);
    const sgst = +(totalTax/2);
    taxableText.textContent = formatINR(taxable);
    cgstText.textContent = formatINR(cgst);
    sgstText.textContent = formatINR(sgst);
    totalText.textContent = formatINR(taxable + cgst + sgst);

    cgstRateSpan.textContent = (gst/2).toFixed(2);
    sgstRateSpan.textContent = (gst/2).toFixed(2);

    return {taxable, cgst, sgst, grand: +(taxable + cgst + sgst).toFixed(2)};
  }

  gstRateEl.addEventListener('change', updateTotals);

  // Save & Print logic with validation
  savePrintBtn.addEventListener('click', ()=>{
    // Gather invoice data
    const rows = Array.from(itemsBody.children);
    const items = [];
    rows.forEach(tr=>{
      const desc = tr.querySelector('td input[type="text"]').value.trim();
      const qty = Number(tr.querySelectorAll('input[type="number"]')[0].value) || 0;
      const rate = Number(tr.querySelectorAll('input[type="number"]')[1].value) || 0;
      const amount = +(qty * rate);
      if(amount > 0) items.push({desc, qty, rate, amount: +amount.toFixed(2)});
    });

    const totals = updateTotals();
    // Validation: don't save/print if taxable (subtotal) is zero or no valid items
    if(items.length === 0 || totals.taxable <= 0){
      alert('Cannot save/print invoice with zero amount. Enter at least one item with non-zero amount.');
      return;
    }

    // Build invoice object
    const invoiceObj = {
      id: invoiceNoPreview.textContent,
      number: invoiceNoPreview.textContent,
      date: invoiceDate.value,
      customerName: customerNameEl.value.trim() || '',
      gstRate: Number(gstRateEl.value) || 0,
      items,
      totals,
      createdAt: new Date().toISOString()
    };

    // Save to localStorage (append or overwrite)
    const saved = getSaved();
    const existsIndex = saved.findIndex(s => s.id === invoiceObj.id);
    if(existsIndex >= 0){
      if(!confirm('An invoice with this number exists. Overwrite?')) return;
      saved[existsIndex] = invoiceObj;
    } else {
      saved.push(invoiceObj);
    }
    setSaved(saved);

    // Print current invoice (items are visible because we haven't reset)
    // Delay a tiny bit to ensure localStorage write completes on slower devices
    setTimeout(()=>{
      window.print();
      // After print dialog, bump invoice number and reset invoice for next
      // Use another small delay so print dialog had chance to open
      setTimeout(()=>{
        bumpNext();
        resetInvoiceFields();
      }, 300);
    }, 150);
  });

  // Reset (manual)
  resetBtn.addEventListener('click', ()=>{
    if(!confirm('Reset current invoice (items cleared)?')) return;
    resetInvoiceFields(false);
  });

  function resetInvoiceFields(setToNext=true){
    // Clear items and fields
    itemsBody.innerHTML = '';
    addItemRow();
    // If setToNext true (after save) show next invoice, else keep same invoice number
    if(setToNext){
      invoiceNoPreview.textContent = 'INV-' + getNext();
    } else {
      // keep current invoice number (do not increment)
      invoiceNoPreview.textContent = invoiceNoPreview.textContent;
    }
    invoiceDate.value = new Date().toISOString().slice(0,10);
    customerNameEl.value = '';
    gstRateEl.value = '18';
    updateTotals();
  }

  // Initialize row numbering observer
  new MutationObserver(updateRowNumbers).observe(itemsBody, {childList:true});

  // Expose a function to add initial row when empty
  function ensureAtLeastOneRow(){
    if(itemsBody.children.length === 0) addItemRow();
  }

  // Initial ensure
  ensureAtLeastOneRow();

  // Keep totals live on any input change
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) updateTotals();
  });

  // Keep invoice number visible on load (if next changed elsewhere)
  invoiceNoPreview.textContent = 'INV-' + getNext();
</script>
</body>
</html>