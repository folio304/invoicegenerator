<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vaada and Associates — Invoice Generator</title>
  <style>
    :root{
      --accent:#3b82f6; /* soft blue */
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f3f4f6;
      --radius:12px;
      --max-width:1100px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:var(--bg);margin:0;padding:24px;color:#0f172a}
    .container{max-width:var(--max-width);margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    header h1{margin:0;font-size:20px;color:#0f172a}
    header small{display:block;font-size:12px;color:var(--muted)}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
    .flex{display:flex;gap:12px;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input[type="text"], input[type="email"], input[type="number"], input[type="date"], textarea, select {
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:white;font-size:14px;
    }
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .two{flex:1 1 220px}
    .three{flex:1 1 140px}
    .logo-preview{width:140px;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:1px dashed #e6e9ee;overflow:hidden;background:#fff}
    .logo-preview img{max-width:100%;max-height:100%}
    .muted{color:var(--muted);font-size:13px}
    /* Items table */
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
    th{background:#fbfdff;color:var(--muted);font-weight:600}
    .qty, .rate, .amount{text-align:right}
    .small-btn{padding:8px 10px;border-radius:8px;border:0;background:#eef2ff;color:var(--accent);cursor:pointer}
    .danger{background:#fff0f0;color:#ef4444;border:1px solid #fee2e2}
    .primary{background:var(--accent);color:white;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .secondary{background:#efefef;color:#374151;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .totals{max-width:380px;margin-left:auto}
    .totals .line{display:flex;justify-content:space-between;padding:8px 0}
    .sticky-top{position:sticky;top:18px}
    /* Saved invoices list */
    .saved-list{max-height:300px;overflow:auto}
    .saved-item{padding:8px;border-radius:8px;border:1px solid #eef2f6;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .note{font-size:13px;color:var(--muted)}
    footer{margin-top:14px;text-align:center;color:var(--muted);font-size:13px}
    /* Responsive */
    @media (max-width:900px){
      .sticky-top{position:static}
      .totals{width:100%;margin-left:0}
      .logo-preview{width:120px;height:52px}
    }
    /* Print styles: hide controls and beautify invoice for print */
    @media print {
      body{background:white;padding:0}
      header, .controls, .saved-panel, .top-actions{display:none}
      .card{box-shadow:none;border-radius:0;padding:0}
      .container{max-width:100%;padding:0}
      table th, table td{font-size:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Vaada and Associates</h1>
        <small>Invoice Generator — Static • GitHub Pages</small>
      </div>
      <div class="flex">
        <div style="text-align:right">
          <div class="muted">Auto-increment Invoice #</div>
          <div id="preview-invoice-no" style="font-weight:700;font-size:16px">INV-1</div>
        </div>
      </div>
    </header>

    <div class="card">
      <div class="row" style="align-items:center">
        <div style="flex:1">
          <div class="row">
            <div class="two">
              <label>Firm Name</label>
              <input id="firmName" type="text" value="Vaada and Associates">
            </div>
            <div class="two">
              <label>Firm Address</label>
              <input id="firmAddress" type="text" placeholder="Address, City, State - PIN">
            </div>
            <div class="three">
              <label>Firm Email</label>
              <input id="firmEmail" type="email" placeholder="info@vaada.in">
            </div>
            <div class="three">
              <label>Firm GSTIN (optional)</label>
              <input id="firmGstin" type="text" placeholder="12ABCDE1234F1Z5">
            </div>
          </div>
        </div>

        <div style="width:160px">
          <label>Logo (optional)</label>
          <div class="logo-preview" id="logoPreview">LOGO</div>
          <input id="logoInput" type="file" accept="image/*" style="margin-top:8px">
          <div style="margin-top:6px">
            <button class="small-btn" id="removeLogoBtn">Remove</button>
          </div>
        </div>
      </div>

      <hr style="margin:18px 0;border:none;border-top:1px solid #eef2f6">

      <!-- Invoice & Client -->
      <div class="row">
        <div style="flex:1">
          <div class="row">
            <div class="two">
              <label>Invoice No</label>
              <input id="invoiceNo" type="text" />
            </div>
            <div class="two">
              <label>Date</label>
              <input id="invoiceDate" type="date" />
            </div>
            <div class="two">
              <label>Due Date</label>
              <input id="dueDate" type="date" />
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Bill To</label>
            <input id="clientName" type="text" placeholder="Client name">
            <div style="display:flex;gap:12px;margin-top:8px">
              <input id="clientEmail" type="email" placeholder="Client email" style="flex:1">
              <input id="clientGstin" type="text" placeholder="GSTIN (opt)" style="flex:1">
            </div>
            <textarea id="clientAddress" rows="3" style="margin-top:8px" placeholder="Client address"></textarea>
          </div>
        </div>

        <div class="totals card sticky-top" style="padding:12px;box-shadow:none;border-radius:10px">
          <div>
            <label>GST Rate</label>
            <select id="gstRate">
              <option value="0">No GST</option>
              <option value="5">5%</option>
              <option value="18" selected>18%</option>
            </select>
          </div>

          <div style="margin-top:12px">
            <label>Notes</label>
            <textarea id="notes" rows="4" placeholder="Thank you for your business. Payment due within 30 days."></textarea>
          </div>

          <div style="margin-top:12px">
            <label>Signature / Authorized</label>
            <div style="height:48px;border:1px dashed #e6e9ee;border-radius:8px;display:flex;align-items:center;justify-content:center" id="signatureLine">Signature</div>
          </div>
        </div>
      </div>

      <!-- Items -->
      <div style="margin-top:16px">
        <label>Items</label>
        <div style="overflow:auto">
          <table id="itemsTable" aria-label="Items">
            <thead>
              <tr>
                <th style="width:40%">Item & Description</th>
                <th style="width:12%">Qty</th>
                <th style="width:16%">Rate</th>
                <th style="width:16%">Amount</th>
                <th style="width:16%"></th>
              </tr>
            </thead>
            <tbody id="itemsBody">
              <!-- rows added dynamically -->
            </tbody>
          </table>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div>
            <button id="addRowBtn" class="small-btn">+ Add row</button>
            <button id="clearRowsBtn" class="small-btn danger">Clear items</button>
          </div>

          <div style="max-width:380px">
            <div class="line" style="border-top:1px solid #eef2f6;padding-top:12px">
              <div class="muted">Subtotal</div>
              <div id="subtotalText">₹0.00</div>
            </div>
            <div class="line">
              <div class="muted">CGST (<span id="cgstRate">0</span>%)</div>
              <div id="cgstText">₹0.00</div>
            </div>
            <div class="line">
              <div class="muted">SGST (<span id="sgstRate">0</span>%)</div>
              <div id="sgstText">₹0.00</div>
            </div>
            <div class="line" style="font-weight:700;font-size:18px;border-top:1px solid #eef2f6;margin-top:8px;padding-top:8px">
              <div>Total</div>
              <div id="totalText">₹0.00</div>
            </div>
          </div>
        </div>
      </div>

      <hr style="margin:18px 0;border:none;border-top:1px solid #eef2f6">

      <div class="row" style="align-items:center;justify-content:space-between">
        <div class="controls top-actions">
          <button id="saveBtn" class="primary">Save Invoice</button>
          <button id="printBtn" class="secondary">Generate PDF (Print)</button>
          <button id="newBtn" class="small-btn">Reset / New</button>
          <button id="viewSavedBtn" class="small-btn">View Saved Invoices</button>
        </div>

        <div class="muted">Auto-increment key stored locally in your browser.</div>
      </div>
    </div>

    <!-- Saved invoices panel (hidden toggle) -->
    <div id="savedPanel" class="card saved-panel" style="margin-top:16px;display:none">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;font-size:16px">Saved Invoices</h3>
        <div>
          <button id="closeSaved" class="small-btn">Close</button>
          <button id="exportAll" class="small-btn">Export JSON</button>
          <button id="clearAllSaved" class="small-btn danger">Clear All</button>
        </div>
      </div>

      <div class="saved-list" id="savedList" style="margin-top:12px"></div>
    </div>

    <footer>
      <div>Built for Vaada and Associates — static, privacy-friendly. All data stays in your browser.</div>
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (id)=>document.getElementById(id);
    const formatMoney = n => {
      const num = Number(n) || 0;
      return '₹' + num.toFixed(2);
    };
    const todayISO = () => {
      const d = new Date();
      return d.toISOString().slice(0,10); // yyyy-mm-dd
    };

    // ---------- Keys & Defaults ----------
    const KEY_NEXT = 'vaada_invoice_next';
    const KEY_SAVED = 'vaada_invoices';
    const KEY_SETTINGS = 'vaada_settings';

    // ---------- DOM Elements ----------
    const invoiceNoEl = $('invoiceNo');
    const previewInvoice = $('preview-invoice-no');
    const invoiceDateEl = $('invoiceDate');
    const dueDateEl = $('dueDate');
    const itemsBody = $('itemsBody');
    const addRowBtn = $('addRowBtn');
    const clearRowsBtn = $('clearRowsBtn');
    const subtotalText = $('subtotalText');
    const cgstText = $('cgstText');
    const sgstText = $('sgstText');
    const totalText = $('totalText');
    const gstRateEl = $('gstRate');
    const cgstRateSpan = $('cgstRate');
    const sgstRateSpan = $('sgstRate');
    const saveBtn = $('saveBtn');
    const printBtn = $('printBtn');
    const newBtn = $('newBtn');
    const viewSavedBtn = $('viewSavedBtn');
    const savedPanel = $('savedPanel');
    const savedList = $('savedList');
    const closeSaved = $('closeSaved');
    const exportAll = $('exportAll');
    const clearAllSaved = $('clearAllSaved');
    const logoInput = $('logoInput');
    const logoPreview = $('logoPreview');
    const removeLogoBtn = $('removeLogoBtn');

    // Additional fields to save as settings
    const firmNameEl = $('firmName');
    const firmAddressEl = $('firmAddress');
    const firmEmailEl = $('firmEmail');
    const firmGstinEl = $('firmGstin');
    const notesEl = $('notes');
    const clientNameEl = $('clientName');
    const clientEmailEl = $('clientEmail');
    const clientGstinEl = $('clientGstin');
    const clientAddressEl = $('clientAddress');

    // ---------- Init ----------
    function getNextInvoiceNumber(){
      const raw = localStorage.getItem(KEY_NEXT);
      let n = raw ? parseInt(raw,10) : 1;
      if (!Number.isFinite(n) || n<1) n = 1;
      return n;
    }
    function setNextInvoiceNumber(n){
      localStorage.setItem(KEY_NEXT, String(n));
    }
    function bumpInvoiceNumber(){
      const n = getNextInvoiceNumber()+1;
      setNextInvoiceNumber(n);
    }

    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem(KEY_SETTINGS) || '{}');
        if(s.logo) setLogoPreview(s.logo);
        if(s.gstRate) gstRateEl.value = s.gstRate;
        if(s.firmName) firmNameEl.value = s.firmName;
        if(s.firmAddress) firmAddressEl.value = s.firmAddress;
        if(s.firmEmail) firmEmailEl.value = s.firmEmail;
        if(s.firmGstin) firmGstinEl.value = s.firmGstin;
        if(s.notes) notesEl.value = s.notes;
      }catch(e){}
    }
    function saveSettings(){
      const s = {
        logo: logoPreview.dataset.logo || null,
        gstRate: gstRateEl.value,
        firmName: firmNameEl.value,
        firmAddress: firmAddressEl.value,
        firmEmail: firmEmailEl.value,
        firmGstin: firmGstinEl.value,
        notes: notesEl.value
      };
      localStorage.setItem(KEY_SETTINGS, JSON.stringify(s));
    }

    function init(){
      // Invoice numbering
      let n = getNextInvoiceNumber();
      invoiceNoEl.value = `INV-${n}`;
      previewInvoice.textContent = invoiceNoEl.value;

      // Dates
      invoiceDateEl.value = todayISO();
      const due = new Date(); due.setDate(due.getDate() + 30);
      dueDateEl.value = due.toISOString().slice(0,10);

      // initial item
      addRow();

      // load settings and saved invoices
      loadSettings();
      updateGSTUI();
      renderSavedList();
      recalcAll();
    }
    init();

    // ---------- Logo handling ----------
    function setLogoPreview(dataUrl){
      logoPreview.innerHTML = '';
      if(!dataUrl){
        logoPreview.textContent = 'LOGO';
        delete logoPreview.dataset.logo;
        return;
      }
      const img = document.createElement('img');
      img.src = dataUrl;
      logoPreview.appendChild(img);
      logoPreview.dataset.logo = dataUrl;
    }
    logoInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        setLogoPreview(reader.result);
        saveSettings();
      };
      reader.readAsDataURL(f);
    });
    removeLogoBtn.addEventListener('click', ()=>{
      logoInput.value='';
      setLogoPreview(null);
      saveSettings();
    });

    // ---------- Items logic ----------
    function addRow(item = {desc:'', qty:1, rate:0}){
      const tr = document.createElement('tr');

      const tdDesc = document.createElement('td');
      const descInput = document.createElement('input');
      descInput.type='text'; descInput.value = item.desc || '';
      descInput.placeholder = 'Item description';
      descInput.addEventListener('input', recalcAll);
      tdDesc.appendChild(descInput);

      const tdQty = document.createElement('td');
      const qtyInput = document.createElement('input');
      qtyInput.type='number'; qtyInput.min = '0'; qtyInput.step='1'; qtyInput.value = item.qty || 1;
      qtyInput.className='qty';
      qtyInput.addEventListener('input', recalcAll);
      tdQty.appendChild(qtyInput);

      const tdRate = document.createElement('td');
      const rateInput = document.createElement('input');
      rateInput.type='number'; rateInput.min='0'; rateInput.step='0.01'; rateInput.value = item.rate || 0;
      rateInput.className='rate';
      rateInput.addEventListener('input', recalcAll);
      tdRate.appendChild(rateInput);

      const tdAmount = document.createElement('td');
      tdAmount.className='amount';
      tdAmount.textContent = formatMoney(0);

      const tdActions = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className='small-btn danger';
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', ()=>{
        tr.remove();
        recalcAll();
      });
      tdActions.appendChild(delBtn);

      tr.appendChild(tdDesc);
      tr.appendChild(tdQty);
      tr.appendChild(tdRate);
      tr.appendChild(tdAmount);
      tr.appendChild(tdActions);

      itemsBody.appendChild(tr);
      recalcAll();
    }

    function clearItems(){
      itemsBody.innerHTML='';
      addRow();
      recalcAll();
    }

    addRowBtn.addEventListener('click', ()=>addRow());
    clearRowsBtn.addEventListener('click', ()=> {
      if(confirm('Clear all item rows?')) clearItems();
    });

    // ---------- Recalculate totals ----------
    function recalcAll(){
      // gather items
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      let subtotal = 0;
      rows.forEach(row=>{
        const qty = Number(row.querySelector('input[type="number"]').value) || 0;
        const rate = Number(row.querySelectorAll('input[type="number"]')[1].value) || 0;
        // ensure arithmetic done correctly
        const amount = (qty * rate);
        const amtCell = row.querySelector('td.amount');
        amtCell.textContent = formatMoney(amount);
        subtotal += amount;
      });

      subtotalText.textContent = formatMoney(subtotal);

      const gstRate = Number(gstRateEl.value) || 0;
      // If gstRate is 0 => no tax
      let cgst = 0, sgst = 0;
      if(gstRate > 0){
        const totalTax = (subtotal * gstRate) / 100;
        // split evenly for CGST/SGST
        cgst = totalTax / 2;
        sgst = totalTax / 2;
      }
      cgstText.textContent = formatMoney(cgst);
      sgstText.textContent = formatMoney(sgst);

      const grand = subtotal + cgst + sgst;
      totalText.textContent = formatMoney(grand);

      // Update preview invoice number
      previewInvoice.textContent = invoiceNoEl.value;
      cgstRateSpan.textContent = (gstRate/2).toFixed(2);
      sgstRateSpan.textContent = (gstRate/2).toFixed(2);

      // persist settings (gst, logo, firm info)
      saveSettings();
    }

    gstRateEl.addEventListener('change', ()=> {
      updateGSTUI();
      recalcAll();
    });

    function updateGSTUI(){
      const g = Number(gstRateEl.value) || 0;
      cgstRateSpan.textContent = (g/2).toFixed(2);
      sgstRateSpan.textContent = (g/2).toFixed(2);
    }

    // ---------- Save / Load invoices ----------
    function getSavedInvoices(){
      try{
        return JSON.parse(localStorage.getItem(KEY_SAVED) || '[]');
      }catch(e){
        return [];
      }
    }
    function setSavedInvoices(list){
      localStorage.setItem(KEY_SAVED, JSON.stringify(list));
    }

    function collectInvoiceData(){
      // collect items array
      const rows = Array.from(itemsBody.querySelectorAll('tr'));
      const items = rows.map(row=>{
        const desc = row.querySelector('td input[type="text"]').value || '';
        const qty = Number(row.querySelectorAll('input[type="number"]')[0].value) || 0;
        const rate = Number(row.querySelectorAll('input[type="number"]')[1].value) || 0;
        const amount = Number((qty * rate).toFixed(2));
        return {desc, qty, rate, amount};
      });

      // compute totals exactly as displayed
      const subtotal = items.reduce((s,i)=>s + i.amount, 0);
      const gstRate = Number(gstRateEl.value) || 0;
      const totalTax = (subtotal * gstRate) / 100;
      const cgst = Number((totalTax/2).toFixed(2));
      const sgst = Number((totalTax/2).toFixed(2));
      const grand = Number((subtotal + cgst + sgst).toFixed(2));

      const payload = {
        id: invoiceNoEl.value,
        number: invoiceNoEl.value,
        date: invoiceDateEl.value,
        dueDate: dueDateEl.value,
        firm: {
          name: firmNameEl.value,
          address: firmAddressEl.value,
          email: firmEmailEl.value,
          gstin: firmGstinEl.value,
          logo: logoPreview.dataset.logo || null
        },
        client: {
          name: clientNameEl.value,
          email: clientEmailEl.value,
          gstin: clientGstinEl.value,
          address: clientAddressEl.value
        },
        items,
        subtotal: Number(subtotal.toFixed(2)),
        gstRate,
        cgst,
        sgst,
        total: grand,
        notes: notesEl.value,
        createdAt: new Date().toISOString()
      };
      return payload;
    }

    saveBtn.addEventListener('click', ()=>{
      const inv = collectInvoiceData();

      const saved = getSavedInvoices();
      // if invoice with same id exists, update it
      const idx = saved.findIndex(s=>s.id === inv.id);
      if(idx >= 0){
        if(!confirm('An invoice with this number already exists. Overwrite?')) return;
        saved[idx] = inv;
      } else {
        saved.push(inv);
      }
      setSavedInvoices(saved);
      // bump next invoice number if saving a new invoice
      const currNum = getNextInvoiceNumber();
      const nFromInput = Number((inv.number || '').replace(/[^0-9]/g,'') || currNum);
      if(nFromInput >= currNum) setNextInvoiceNumber(nFromInput + 1);

      alert('Invoice saved locally.');
      renderSavedList();
    });

    // ---------- Print ----------
    printBtn.addEventListener('click', ()=>{
      // ensure totals updated
      recalcAll();
      // hide UI elements in print via CSS @media print
      // open print
      window.print();
    });

    // ---------- New / Reset ----------
    newBtn.addEventListener('click', ()=>{
      if(!confirm('Reset this invoice to create a new one? Unsaved changes will be lost.')) return;
      // set invoice number to next
      const next = getNextInvoiceNumber();
      invoiceNoEl.value = `INV-${next}`;
      previewInvoice.textContent = invoiceNoEl.value;
      invoiceDateEl.value = todayISO();
      const due = new Date(); due.setDate(due.getDate() + 30);
      dueDateEl.value = due.toISOString().slice(0,10);
      clearItems();
      // clear client fields
      clientNameEl.value = '';
      clientEmailEl.value = '';
      clientAddressEl.value = '';
      clientGstinEl.value = '';
      notesEl.value = '';
      recalcAll();
    });

    // ---------- Saved panel UI ----------
    viewSavedBtn.addEventListener('click', ()=>{
      savedPanel.style.display = 'block';
      renderSavedList();
    });
    closeSaved.addEventListener('click', ()=> savedPanel.style.display='none');

    function renderSavedList(){
      const saved = getSavedInvoices();
      savedList.innerHTML = '';
      if(!saved.length){
        savedList.innerHTML = '<div class="note">No invoices saved yet.</div>';
        return;
      }
      // show newest first
      const list = saved.slice().reverse();
      list.forEach(inv=>{
        const item = document.createElement('div');
        item.className = 'saved-item';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:600">${inv.number}</div>
                          <div class="note">${inv.client.name || '—'} • ${new Date(inv.createdAt).toLocaleString()}</div>`;
        const right = document.createElement('div');
        right.style.display='flex'; right.style.gap='8px';
        const loadBtn = document.createElement('button'); loadBtn.className='small-btn';
        loadBtn.textContent='Load'; loadBtn.addEventListener('click', ()=> loadInvoice(inv.id));
        const downloadBtn = document.createElement('button'); downloadBtn.className='small-btn';
        downloadBtn.textContent='Download'; downloadBtn.addEventListener('click', ()=> downloadInvoiceJSON(inv));
        const delBtn = document.createElement('button'); delBtn.className='small-btn danger';
        delBtn.textContent='Delete'; delBtn.addEventListener('click', ()=>{
          if(!confirm('Delete this saved invoice?')) return;
          const all = getSavedInvoices().filter(s=>s.id !== inv.id);
          setSavedInvoices(all);
          renderSavedList();
        });
        right.appendChild(loadBtn);
        right.appendChild(downloadBtn);
        right.appendChild(delBtn);
        item.appendChild(left);
        item.appendChild(right);
        savedList.appendChild(item);
      });
    }

    function loadInvoice(id){
      const saved = getSavedInvoices();
      const inv = saved.find(s=>s.id === id);
      if(!inv) return alert('Invoice not found');
      // populate fields
      invoiceNoEl.value = inv.number || invoiceNoEl.value;
      previewInvoice.textContent = invoiceNoEl.value;
      invoiceDateEl.value = inv.date || todayISO();
      dueDateEl.value = inv.dueDate || '';
      firmNameEl.value = inv.firm?.name || firmNameEl.value;
      firmAddressEl.value = inv.firm?.address || '';
      firmEmailEl.value = inv.firm?.email || '';
      firmGstinEl.value = inv.firm?.gstin || '';
      if(inv.firm?.logo) setLogoPreview(inv.firm.logo);
      clientNameEl.value = inv.client?.name || '';
      clientEmailEl.value = inv.client?.email || '';
      clientGstinEl.value = inv.client?.gstin || '';
      clientAddressEl.value = inv.client?.address || '';
      gstRateEl.value = inv.gstRate != null ? inv.gstRate : '0';
      notesEl.value = inv.notes || '';
      // populate items
      itemsBody.innerHTML = '';
      if(inv.items && inv.items.length){
        inv.items.forEach(it => addRow({desc:it.desc, qty:it.qty, rate:it.rate}));
      } else {
        addRow();
      }
      recalcAll();
      savedPanel.style.display='none';
      alert('Invoice loaded. You can edit and re-save or print.');
    }

    function downloadInvoiceJSON(inv){
      const w = JSON.stringify(inv, null, 2);
      const blob = new Blob([w], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${inv.number || 'invoice'}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    exportAll.addEventListener('click', ()=>{
      const all = getSavedInvoices();
      if(!all.length) return alert('No saved invoices to export.');
      const blob = new Blob([JSON.stringify(all, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `vaada_invoices_export_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    clearAllSaved.addEventListener('click', ()=>{
      if(!confirm('Clear ALL saved invoices? This cannot be undone.')) return;
      localStorage.removeItem(KEY_SAVED);
      renderSavedList();
    });

    // ---------- load saved settings periodically ----------
    setInterval(()=>saveSettings(), 2000);

    // ---------- Update totals when any input changes ----------
    document.addEventListener('input', (e)=>{
      // only recalc when relevant inputs change to avoid overwork
      if(e.target.closest('#itemsTable') || e.target === gstRateEl || e.target.type === 'date' || e.target === notesEl){
        recalcAll();
      }
      if([firmNameEl, firmAddressEl, firmEmailEl, firmGstinEl, notesEl].includes(e.target)) saveSettings();
      // invoice number edit should update preview
      if(e.target === invoiceNoEl) previewInvoice.textContent = invoiceNoEl.value;
    });

    // Keep saved list in sync if storage changes in another tab
    window.addEventListener('storage', (e)=>{
      if(e.key === KEY_SAVED || e.key === KEY_SETTINGS || e.key === KEY_NEXT){
        renderSavedList();
        loadSettings();
      }
    });

    // Prevent accidental numeric inputs to show stepper arrows ugly on mobile? Left as default.
    // ---------- End ----------
  </script>
</body>
</html>